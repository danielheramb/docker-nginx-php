fastcgi_cache_path /cache/fastcgi_cache levels=1:1 keys_zone=fastcgi:128m inactive=1d max_size=512m;

upstream www_php {
    # According to wiki.nginx.org/Drupal You will get better performance and more security by binding to a socket.
    # You're no longer exposing a point of attack. With ports you're limited to the number of ports available on the system and you can't dynamically allocate them.
    # In the case of sockets, you can control, allocate, and utilize them much easier.
    server unix:/var/run/php7-fpm.sock max_fails=0;
}

server {
        server_name _;
        listen 80;
        root /www/nba/;  #Your only path reference.

        access_log /var/log/nginx/access.log main;
        error_log /var/log/nginx/error.log;

        # If using an NFS root, set sendfile and tcp_nopush to off, otherwise set to on.
        sendfile off;
        tcp_nopush off;

        # Add header to see cache status in header (MISS, EXPIRED, UPDATING, STALE or HIT)
        add_header X-Cache-Status $upstream_cache_status;

        keepalive_timeout 65;

        client_max_body_size 50m;
 
        gzip  on;
        gzip_comp_level 2;
        gzip_proxied any;
        gzip_types text/plain text/css application/x-javascript text/xml application/xml application/xml+rss text/javascript;

        ssi on;
        ssi_silent_errors off;
        ssi_types text/plain;

        if ($http_cookie ~ "(^|[;,])\s*SESS") {
            set $no_cache 1;
        }

        # Disable all caching for admin template
        set $no_cache 1;

        client_body_temp_path /dev/shm/client_body_temp;
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        #NOTE: You should have "cgi.fix_pathinfo = 0;" in php.ini
        include fastcgi_params;
        fastcgi_index index.php;
        fastcgi_intercept_errors on;
        fastcgi_next_upstream error timeout invalid_header http_500 http_503;
        fastcgi_cache_use_stale updating error timeout invalid_header http_500 http_503;
        fastcgi_cache_key $host$request_method$request_uri;
        fastcgi_cache_valid 200 1m;
        fastcgi_cache_valid 404 10s;
        fastcgi_cache_valid 301 302 1h;
        fastcgi_connect_timeout 240;
        fastcgi_read_timeout 240;
        fastcgi_send_timeout 240;
        fastcgi_buffer_size 32k;
        fastcgi_buffers 16 32k;
        fastcgi_busy_buffers_size 64k;
        fastcgi_temp_file_write_size 64k;

        # this is nginx status
        location = /server-status {
            allow 10.0.0.0/8;
            allow 127.0.0.1;
            deny   all;
            stub_status on;
        }

        # this is php-fpm status enabled in /etc/php5/fpm/pool.d/www.conf
        location = /fpm-status {
            fastcgi_pass www_php;
            fastcgi_cache off;
            allow 10.0.0.0/8;
            allow 127.0.0.1;
            deny   all;
        }

        # this is php-fpm ping, enabled in /etc/php5/fpm/pool.d/www.conf
        location = /fpm-ping {
            fastcgi_pass www_php;
            fastcgi_cache off;
            allow 10.0.0.0/8;
            allow 127.0.0.1;
            deny   all;
        }

        location = /favicon.ico {
            expires max;
            log_not_found off;
            access_log off;
            try_files $uri @rewrite;
        }
 
        location = /robots.txt {
            allow all;
            log_not_found off;
            access_log off;
            try_files $uri @rewrite;
        }
 
        # Very rarely should these ever be accessed outside of your lan
        location ~* \.(txt|log)$ {
            allow 10.0.0.0/8;
            deny all;
        }
 
        location ~ \..*/.*\.php$ {
            return 403;
        }

        location ~* \.(engine|inc|info|install|make|module|profile|test|po|sh|.sql|theme|tpl(\.php)?|txt|xtmpl|svn-base)$|(code-style\.pl|Entries.|Repository|Root|Tag|Template|all-wcprops|entries|format|/manifest)$
        { deny all; }

#        location ~* \.(aspx|bak|doc|ini|pdf|tmp|txt)$ {
#            try_files $uri =404;
#            log_not_found off;
#        }   

        location / {
            # This is cool because no php is touched for static content
            try_files $uri =404;
        }
 
        location ~ \.php$ {

            root /www/nba-drupal/core/release;
            fastcgi_split_path_info ^(.+\.php)(/.+)$;
            #NOTE: You should have "cgi.fix_pathinfo = 0;" in php.ini
            include fastcgi_params;
            fastcgi_index index.php;
            fastcgi_intercept_errors on;
            client_body_in_file_only clean;
            fastcgi_param  REQUEST_BODY_FILE  $request_body_file;
            fastcgi_pass unix:/var/run/php7-fpm.sock;
            fastcgi_cache off;
            fastcgi_no_cache "1";
            fastcgi_cache_bypass "1"; 
            fastcgi_ignore_headers Cache-Control Expires;
            fastcgi_hide_header Cache-Control;
            fastcgi_hide_header Expires;
        }  

 
}
